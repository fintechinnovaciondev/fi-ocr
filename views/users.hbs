<div class="space-y-6">
  <div class="flex justify-between items-center">
    <div>
      <h2 class="text-2xl font-bold text-gray-800">Administración de Usuarios</h2>
      <p class="text-sm text-gray-500">Gestiona los permisos y el acceso de los usuarios del sistema.</p>
    </div>
    <button onclick="openModal()" class="bg-indigo-600 text-white px-4 py-2 rounded-lg text-sm font-bold hover:bg-indigo-700 transition flex items-center shadow-sm">
        <i class="fas fa-plus mr-2"></i> Nuevo Usuario
    </button>
  </div>

  <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
    <table class="min-w-full divide-y divide-gray-200 text-sm">
      <thead class="bg-gray-50">
        <tr>
          <th class="px-6 py-4 text-left font-semibold text-gray-600 uppercase tracking-wider">Usuario</th>
          <th class="px-6 py-4 text-left font-semibold text-gray-600 uppercase tracking-wider">Email</th>
          <th class="px-6 py-4 text-left font-semibold text-gray-600 uppercase tracking-wider">Rol</th>
          <th class="px-6 py-4 text-left font-semibold text-gray-600 uppercase tracking-wider">Estado</th>
          <th class="px-6 py-4 text-left font-semibold text-gray-600 uppercase tracking-wider">Último Acceso</th>
          <th class="px-6 py-4 text-center font-semibold text-gray-600 uppercase tracking-wider">Acciones</th>
        </tr>
      </thead>
      <tbody class="divide-y divide-gray-200">
        {{#each users}}
        <tr class="hover:bg-gray-50 transition-colors">
          <td class="px-6 py-4">
            <div class="flex items-center space-x-3">
              <img src="{{this.picture}}" class="w-8 h-8 rounded-full border border-gray-100" />
              <span class="font-medium text-gray-900">{{this.firstName}} {{this.lastName}}</span>
            </div>
          </td>
          <td class="px-6 py-4 text-gray-600">{{this.email}}</td>
          <td class="px-6 py-4">
            <select 
              class="bg-gray-50 border border-gray-300 text-gray-900 text-xs rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2"
              onchange="updateRole('{{this._id}}', this.value)"
            >
              {{#each ../roles}}
              <option value="{{this}}" {{#if (eq this ../role)}}selected{{/if}}>{{this}}</option>
              {{/each}}
            </select>
          </td>
          <td class="px-6 py-4">
            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium {{#if this.isActive}}bg-green-100 text-green-800{{else}}bg-red-100 text-red-800{{/if}}">
              {{#if this.isActive}}Activo{{else}}Inactivo{{/if}}
            </span>
          </td>
          <td class="px-6 py-4 text-gray-500 text-xs">
            {{#if this.lastLogin}}
              {{formatDate this.lastLogin}}
            {{else}}
              Nunca
            {{/if}}
          </td>
          <td class="px-6 py-4 text-center">
            <div class="flex items-center justify-center space-x-2">
              <button 
                onclick="openModal({
                  _id: '{{this._id}}',
                  firstName: '{{this.firstName}}',
                  lastName: '{{this.lastName}}',
                  email: '{{this.email}}',
                  role: '{{this.role}}',
                  isActive: {{this.isActive}}
                })"
                class="p-2 text-indigo-600 hover:bg-indigo-50 rounded-lg transition-colors"
                title="Editar datos"
              >
                <i class="fas fa-edit"></i>
              </button>
              <button 
                onclick="toggleStatus('{{this._id}}', {{this.isActive}})"
                class="p-2 {{#if this.isActive}}text-yellow-500 hover:bg-yellow-50{{else}}text-green-500 hover:bg-green-50{{/if}} rounded-lg transition-colors"
                title="{{#if this.isActive}}Desactivar{{else}}Activar{{/if}}"
              >
                <i class="fas {{#if this.isActive}}fa-user-slash{{else}}fa-user-check{{/if}}"></i>
              </button>
              <button 
                onclick="deleteUser('{{this._id}}', '{{this.email}}')"
                class="p-2 text-red-500 hover:bg-red-50 rounded-lg transition-colors"
                title="Eliminar"
              >
                <i class="fas fa-trash"></i>
              </button>
            </div>
          </td>
        </tr>
        {{/each}}
      </tbody>
    </table>
  </div>
</div>

<!-- Modal para Crear/Editar Usuario -->
<div id="userModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
  <div class="relative top-20 mx-auto p-8 border w-[500px] shadow-2xl rounded-2xl bg-white transition-all transform animate-in fade-in zoom-in duration-200">
    <div class="flex flex-col space-y-6">
      <div class="flex justify-between items-center border-b pb-4">
        <h3 id="modalTitle" class="text-xl font-bold text-gray-800">Nuevo Usuario</h3>
        <button onclick="closeModal()" class="text-gray-400 hover:text-gray-600 focus:outline-none">
          <i class="fas fa-times"></i>
        </button>
      </div>

      <form id="userForm" class="space-y-4">
        <input type="hidden" id="userId" name="id">
        
        <div class="grid grid-cols-2 gap-4">
          <div class="space-y-1">
            <label class="block text-xs font-bold text-gray-500 uppercase tracking-wider">Nombre</label>
            <input type="text" id="firstName" name="firstName" required class="w-full px-4 py-2 bg-gray-50 border border-gray-200 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none transition-all">
          </div>
          <div class="space-y-1">
            <label class="block text-xs font-bold text-gray-500 uppercase tracking-wider">Apellido</label>
            <input type="text" id="lastName" name="lastName" required class="w-full px-4 py-2 bg-gray-50 border border-gray-200 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none transition-all">
          </div>
        </div>

        <div class="space-y-1">
          <label class="block text-xs font-bold text-gray-500 uppercase tracking-wider">Email</label>
          <input type="email" id="email" name="email" required class="w-full px-4 py-2 bg-gray-50 border border-gray-200 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none transition-all">
        </div>

        <div class="grid grid-cols-2 gap-4">
          <div class="space-y-1">
            <label class="block text-xs font-bold text-gray-500 uppercase tracking-wider">Rol</label>
            <select id="role" name="role" class="w-full px-4 py-2 bg-gray-50 border border-gray-200 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none transition-all">
              {{#each roles}}
                <option value="{{this}}">{{this}}</option>
              {{/each}}
            </select>
          </div>
          <div class="space-y-1">
            <label class="block text-xs font-bold text-gray-500 uppercase tracking-wider">Estado</label>
            <select id="isActive" name="isActive" class="w-full px-4 py-2 bg-gray-50 border border-gray-200 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none transition-all">
              <option value="true">Activo</option>
              <option value="false">Inactivo</option>
            </select>
          </div>
        </div>

        <div class="flex justify-end pt-6 space-x-3">
          <button type="button" onclick="closeModal()" class="px-6 py-2 border border-gray-300 text-gray-700 font-bold rounded-lg hover:bg-gray-50 transition-colors">Cancelar</button>
          <button type="submit" class="px-6 py-2 bg-indigo-600 text-white font-bold rounded-lg hover:bg-indigo-700 shadow-md transition-all">Guardar</button>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
  const userModal = document.getElementById('userModal');
  const userForm = document.getElementById('userForm');
  const modalTitle = document.getElementById('modalTitle');

  function openModal(user = null) {
    if (user) {
      modalTitle.innerText = 'Editar Usuario';
      document.getElementById('userId').value = user._id;
      document.getElementById('firstName').value = user.firstName;
      document.getElementById('lastName').value = user.lastName;
      document.getElementById('email').value = user.email;
      document.getElementById('role').value = user.role;
      document.getElementById('isActive').value = user.isActive.toString();
      // El email no debería editarse si viene de Google, opcional bloquearlo
      // document.getElementById('email').disabled = true;
    } else {
      modalTitle.innerText = 'Nuevo Usuario';
      userForm.reset();
      document.getElementById('userId').value = '';
      // document.getElementById('email').disabled = false;
    }
    userModal.classList.remove('hidden');
  }

  function closeModal() {
    userModal.classList.add('hidden');
  }

  userForm.onsubmit = async (e) => {
    e.preventDefault();
    const formData = new FormData(userForm);
    const data = Object.fromEntries(formData.entries());
    const userId = data.id;
    delete data.id;

    // Convertir isActive de string a boolean
    data.isActive = data.isActive === 'true';

    try {
      const url = userId ? `/auth/users/${userId}` : '/auth/users';
      const method = userId ? 'PATCH' : 'POST';

      const response = await fetch(url, {
        method,
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
      });

      if (!response.ok) {
        const errData = await response.json();
        throw new Error(errData.message || 'Error al guardar usuario');
      }

      showToast('Usuario guardado correctamente');
      setTimeout(() => location.reload(), 1000);
    } catch (error) {
      showToast(error.message, 'error');
    }
  };

  async function updateRole(userId, newRole) {
    try {
      const response = await fetch(`/auth/users/${userId}/role`, {
        method: 'PATCH',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ role: newRole })
      });
      if (!response.ok) throw new Error('Error al actualizar el rol');
      showToast('Rol actualizado correctamente');
    } catch (error) {
      showToast(error.message, 'error');
    }
  }

  async function toggleStatus(userId, currentStatus) {
    try {
      const response = await fetch(`/auth/users/${userId}/status`, {
        method: 'PATCH',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ isActive: !currentStatus })
      });
      if (!response.ok) throw new Error('Error al actualizar el estado');
      showToast('Estado actualizado correctamente');
      setTimeout(() => location.reload(), 1000);
    } catch (error) {
      showToast(error.message, 'error');
    }
  }

  async function deleteUser(userId, email) {
    showConfirm(
      'Eliminar Usuario',
      `¿Estás seguro de que deseas eliminar al usuario ${email}? Esta acción no se puede deshacer.`,
      async () => {
        try {
          const response = await fetch(`/auth/users/${userId}`, {
            method: 'DELETE'
          });
          if (!response.ok) throw new Error('Error al eliminar el usuario');
          showToast('Usuario eliminado correctamente');
          setTimeout(() => location.reload(), 1000);
        } catch (error) {
          showToast(error.message, 'error');
        }
      }
    );
  }
</script>
