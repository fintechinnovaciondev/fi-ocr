<div class="p-8 max-w-4xl mx-auto">
    <div class="mb-8">
        <h1 class="text-3xl font-bold text-gray-800">{{title}}</h1>
        <p class="text-gray-600">Sube un documento manualmente para probar las estrategias de extracción.</p>
    </div>

    <div class="bg-white rounded-2xl shadow-xl p-8 border border-gray-100">
        <form id="ingestaForm" class="space-y-6">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- Cliente -->
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Cliente (Tenant)</label>
                    <select id="tenantSelect" name="tenantId" required
                        class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-indigo-500 transition appearance-none bg-gray-50">
                        <option value="">Seleccione un cliente...</option>
                        {{#each tenants}}
                        <option value="{{this.tenantId}}">{{this.name}} ({{this.tenantId}})</option>
                        {{/each}}
                    </select>
                </div>

                <!-- Tipo de Documento -->
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Tipo de Documento</label>
                    <select id="configSelect" name="type" required
                        class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-indigo-500 transition appearance-none bg-gray-50">
                        <option value="">Seleccione primero un cliente...</option>
                        {{#each configs}}
                        <option value="{{this.slug}}" data-tenant="{{this.tenantId}}" class="hidden">{{this.slug}}</option>
                        {{/each}}
                    </select>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- External ID -->
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">ID Externo</label>
                    <input type="text" name="externalId" placeholder="Referencia del archivo..." required
                        class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-indigo-500 transition bg-gray-50 text-sm">
                </div>

                <!-- Tags -->
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Etiquetas (Separadas por coma)</label>
                    <input type="text" name="tags" placeholder="ej: manual, test, urgente"
                        class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-indigo-500 transition bg-gray-50 text-sm">
                </div>
            </div>

            <!-- Upload Zone -->
            <div class="mt-4">
                <label class="block text-sm font-semibold text-gray-700 mb-2">Archivo (PDF o Imagen)</label>
                <div id="dropzone" class="relative group border-2 border-dashed border-gray-300 rounded-2xl p-12 transition hover:border-indigo-400 hover:bg-indigo-50/30 cursor-pointer text-center">
                    <input type="file" name="file" id="fileInput" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer" accept="image/*,.pdf" required>
                    <div class="space-y-4">
                        <div class="bg-indigo-100 w-16 h-16 rounded-full flex items-center justify-center mx-auto group-hover:scale-110 transition duration-300">
                            <i class="fas fa-cloud-upload-alt text-indigo-600 text-2xl"></i>
                        </div>
                        <div>
                            <p class="text-sm font-bold text-gray-700">Haz clic o arrastra un archivo aquí</p>
                            <p class="text-xs text-gray-400 mt-1">Soporta PDF, PNG, JPG (Max 5MB)</p>
                        </div>
                        <div id="filePreview" class="hidden text-indigo-600 font-bold text-sm">
                            <i class="fas fa-file-alt mr-2"></i> <span id="fileName"></span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="pt-6">
                <button type="submit" id="submitBtn" class="w-full bg-indigo-600 text-white py-4 rounded-2xl font-bold hover:bg-indigo-700 transition shadow-lg transform active:scale-[0.98] flex items-center justify-center space-x-2">
                    <i class="fas fa-rocket"></i>
                    <span>Iniciar Procesamiento OCR</span>
                </button>
            </div>
        </form>
    </div>

    <!-- Ejemplo de Integración -->
    <div class="mt-8 space-y-4">
        <h2 class="text-xl font-bold text-gray-800 flex items-center">
            <i class="fas fa-code mr-2 text-indigo-500"></i> Integración vía API (cURL)
        </h2>
        <div class="bg-gray-900 rounded-2xl p-6 relative group border border-gray-800 shadow-2xl overflow-hidden">
            <div class="absolute top-0 left-0 w-1 h-full bg-indigo-500"></div>
            <div class="flex justify-between items-start mb-4">
                <div class="space-y-1">
                    <p class="text-[10px] font-bold text-gray-500 uppercase tracking-widest">Ejemplo de Invocación Automática</p>
                    <p class="text-indigo-400 font-mono text-xs"><span class="base-url-placeholder"></span>/api/v1/ingesta</p>
                </div>
                <button type="button" onclick="copyCurl()" class="bg-gray-800 text-gray-400 hover:text-white p-2 rounded-lg transition">
                    <i class="fas fa-copy"></i>
                </button>
            </div>
            <pre class="text-gray-300 font-mono text-sm leading-relaxed overflow-x-auto"><code id="curlExample">curl -X POST <span class="base-url-placeholder"></span>/api/v1/ingesta \
  -H "x-api-key: TU_API_KEY" \
  -F "file=@/ruta/al/archivo.pdf" \
  -F "type=TIPO_DE_DOCUMENTO" \
  -F "externalId=REF-01" \
  -F "sync=true"</code></pre>
        </div>
    </div>
</div>

<script>
    // Inicializar placeholders de URL
    document.addEventListener('DOMContentLoaded', () => {
        document.querySelectorAll('.base-url-placeholder').forEach(el => {
            el.innerText = window.location.origin;
        });
    });

    function copyCurl() {
        const text = document.getElementById('curlExample').innerText;
        navigator.clipboard.writeText(text);
        showToast('Copiado al portapapeles');
    }

    // Cache de configuraciones para filtrado rápido
    const allConfigs = Array.from(document.querySelectorAll('#configSelect option[data-tenant]'));

    function filterConfigs() {
        const tenantId = document.getElementById('tenantSelect').value;
        const configSelect = document.getElementById('configSelect');
        
        // Limpiar opciones manteniendo la primera (el placeholder)
        const placeholder = configSelect.options[0];
        configSelect.innerHTML = '';
        configSelect.appendChild(placeholder);
        
        // Filtrar y agregar
        const filtered = allConfigs.filter(opt => opt.dataset.tenant === tenantId);
        filtered.forEach(opt => {
            // Clonar para no perder el original en la primera pasada
            const clone = opt.cloneNode(true);
            clone.classList.remove('hidden');
            configSelect.appendChild(clone);
        });

        configSelect.value = "";
        
        if (tenantId === "") {
            configSelect.options[0].text = "Seleccione primero un cliente...";
        } else if (filtered.length === 0) {
            configSelect.options[0].text = "No hay documentos configurados para este cliente";
        } else {
            configSelect.options[0].text = "Seleccione tipo de documento...";
        }
    }

    // Event Listeners
    document.getElementById('tenantSelect').addEventListener('change', filterConfigs);

    // Preview de nombre de archivo
    document.getElementById('fileInput').addEventListener('change', function(e) {
        const file = e.target.files[0];
        const preview = document.getElementById('filePreview');
        const name = document.getElementById('fileName');
        
        if (file) {
            name.textContent = file.name;
            preview.classList.remove('hidden');
        } else {
            preview.classList.add('hidden');
        }
    });

    document.getElementById('ingestaForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const btn = document.getElementById('submitBtn');
        const originalText = btn.innerHTML;
        
        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> <span>Procesando...</span>';

        const formData = new FormData(e.target);

        try {
            const res = await fetch('/api/admin/ingesta', {
                method: 'POST',
                body: formData
            });

            if (res.ok) {
                const data = await res.json();
                showToast('Documento enviado a la cola de procesamiento');
                setTimeout(() => {
                    window.location.href = '/admin';
                }, 1000);
            } else {
                const err = await res.json();
                showToast('Error: ' + (err.message || 'No se pudo procesar el documento'), 'error');
            }
        } catch (err) {
            console.error(err);
            showToast('Error crítico de red o servidor', 'error');
        } finally {
            btn.disabled = false;
            btn.innerHTML = originalText;
        }
    });
</script>
