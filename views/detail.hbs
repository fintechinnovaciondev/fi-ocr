<style>
/* Estrategia de Layout "App-Shell" Robusta */
html, body { 
    height: 100vh; 
    overflow: hidden; 
}

/* Modificamos el layout principal desde dentro */
main { 
    height: 100vh !important; 
    display: flex !important; 
    flex-direction: column !important; 
    overflow: hidden !important; 
}

/* El contenedor p-8 del layout debe ser el que mande el espacio */
main > div.p-8 {
    flex: 1 !important;
    display: flex !important;
    flex-direction: column !important;
    overflow: hidden !important;
    padding: 1rem !important; /* Reducimos padding para ganar espacio */
}

/* Nuestro validador ocupa todo el flex restante */
#mainValidator {
    flex: 1;
    display: flex;
    overflow: hidden;
}

.tooltip {
    position: relative;
    display: inline-block;
}

.tooltip .tooltiptext {
    visibility: hidden;
    width: auto;
    min-width: 200px;
    background-color: #1f2937;
    color: #fff;
    text-align: left;
    border-radius: 8px;
    padding: 12px;
    position: absolute;
    z-index: 50;
    top: 100%;
    right: 0;
    margin-top: 8px;
    opacity: 0;
    transition: all 0.2s ease-in-out;
    font-size: 0.75rem;
    pointer-events: none;
    box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.4), 0 4px 6px -2px rgba(0, 0, 0, 0.2);
    border: 1px solid #374151;
}

.tooltip .tooltiptext::after {
    content: "";
    position: absolute;
    bottom: 100%;
    right: 14px;
    border-width: 6px;
    border-style: solid;
    border-color: transparent transparent #1f2937 transparent;
}

.tooltip:hover .tooltiptext {
    visibility: visible;
    opacity: 1;
}

.custom-scrollbar::-webkit-scrollbar { width: 6px; height: 6px; }
.custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
.custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
.custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

#zoomWrapper {
    will-change: transform;
}
</style>

<div id='mainValidator' class='flex flex-col lg:flex-row gap-0 bg-gray-50 rounded-xl border border-gray-200 overflow-hidden'>
    <!-- Lado Izquierdo: Formulario (Scrollable) -->
    <div id='formPanel' class='w-1/2 h-full min-w-[30%] max-w-[70%] overflow-y-auto bg-white border-r border-gray-200 custom-scrollbar'>
        <div class='p-8 space-y-6'>
            <div class='flex justify-between items-start mb-6'>
                <div>
                    <h2 class='text-2xl font-bold text-gray-800'>Validación de Datos</h2>
                    <p class='text-gray-500'>ID: {{process._id}}</p>
                </div>
                <div class='flex gap-2'>
                    <button id='reprocessBtn' class='bg-yellow-500 text-white px-4 py-2 rounded-lg text-sm font-bold hover:bg-yellow-600 transition flex items-center'>
                        <i class='fas fa-sync-alt mr-2'></i> Reprocesar
                    </button>
                    <div class='bg-gray-100 rounded-lg flex p-1'>
                        <button id='tabFormBtn' class='px-4 py-2 text-sm font-medium bg-white rounded-md shadow-sm transition-all'>Formulario</button>
                        <button id='tabJsonBtn' class='px-4 py-2 text-sm font-medium text-gray-600 transition-all'>JSON</button>
                    </div>
                </div>
            </div>

            <div class='grid grid-cols-2 gap-8 mb-8 pb-8 border-b border-gray-100'>
                <div>
                    <label class='block text-xs font-bold text-gray-400 uppercase mb-1'>External ID</label>
                    <p class='text-lg font-semibold text-gray-800'>{{process.externalId}}</p>
                </div>
                <div>
                    <label class='block text-xs font-bold text-gray-400 uppercase mb-1'>Estado</label>
                    <div class="flex items-center gap-3">
                        <span id='statusBadge' class='inline-flex items-center px-3 py-1 rounded-full text-sm font-bold 
                            {{#if (eq process.status 'validated')}}bg-green-600 text-white shadow-sm
                            {{else if (eq process.status 'completed')}}bg-green-100 text-green-800
                            {{else if (eq process.status 'failed')}}bg-red-100 text-red-800
                            {{else}}bg-blue-100 text-blue-800{{/if}}'>
                            {{#if (eq process.status 'validated')}}<i class="fas fa-certificate mr-1.5"></i>{{/if}}
                            {{process.status}}
                        </span>
                        
                        <button id='validateBtn' class='bg-indigo-600 text-white px-3 py-1.5 rounded-lg text-xs font-bold hover:bg-indigo-700 transition flex items-center shadow-sm'>
                            <i class='fas fa-check-double mr-2'></i> Validar Datos
                        </button>
                    </div>
                </div>
            </div>

            <div class='flex items-center justify-between mb-4 px-1'>
                <div class='flex items-center gap-2 text-gray-500'>
                    <span class='text-xs font-bold uppercase tracking-widest' id='viewModeLabel'>Lista Contínua</span>
                </div>
                <button id='toggleViewModeBtn' class='flex items-center gap-2 px-3 py-1.5 rounded-lg border border-gray-200 bg-white hover:bg-gray-50 text-gray-600 transition shadow-sm' title='Cambiar modo de visualización'>
                    <i class='fas fa-th-large text-xs' id='toggleViewIcon'></i>
                    <span class='text-xs font-bold'>Agrupar por Secciones</span>
                </button>
            </div>

            <div id='viewForm'>
                <!-- Navegación de Pestañas (Solo visible en modo Agrupado) -->
                <div id='formTabsNav' class='hidden flex flex-wrap gap-1 mb-6 border-b border-gray-100 pb-2'>
                    {{#each process.extractedData as |value key|}}
                        <button type='button' data-tab='{{key}}' class='form-tab-btn px-4 py-2 text-xs font-bold uppercase tracking-wider rounded-t-lg border-b-2 border-transparent text-gray-400 hover:text-gray-600 hover:bg-gray-50 transition-all'>
                            {{key}}
                        </button>
                    {{/each}}
                </div>

                <form id='extractionForm' class='space-y-6'>
                    <div id='formFieldsContainer' class='space-y-4'>
                        {{#each process.extractedData as |value key|}}
                            <div class='form-field-group border-b border-gray-50 p-4 last:border-0' data-group='{{key}}'>
                                <div class='flex items-center justify-between mb-2'>
                                    <label class='block text-sm font-bold text-gray-600 uppercase tracking-tight'>{{key}}</label>
                                    <div class='flex items-center gap-2'>
                                        {{#with (getValidation ../process.validationResults key) as |vals|}}
                                            {{#if vals.length}}
                                                <div class='tooltip group'>
                                                    <span class='cursor-help flex items-center gap-1.5 px-2 py-0.5 rounded text-xs font-bold {{#if (hasValidationError vals)}}bg-red-50 text-red-600 border border-red-100{{else}}bg-green-50 text-green-600 border border-green-100{{/if}}'>
                                                        <i class='fas {{#if (hasValidationError vals)}}fa-exclamation-circle{{else}}fa-check-circle{{/if}}'></i>
                                                        Validación
                                                    </span>
                                                    <!-- Tooltip Content -->
                                                    <div class='tooltiptext invisible group-hover:visible opacity-0 group-hover:opacity-100 w-64 !left-auto !right-0 !ml-0 translate-x-0 p-3 text-left space-y-2 shadow-xl border border-gray-700 bg-gray-800 transition-all duration-200'>
                                                        <div class='font-bold border-b border-gray-600 pb-1.5 mb-2 text-xs uppercase tracking-wider text-gray-400'>
                                                            Reglas Aplicadas
                                                        </div>
                                                        {{#each vals}}
                                                            <div class='flex items-start gap-2 leading-tight'>
                                                                <i class='fas {{#if this.success}}fa-check text-green-400{{else}}fa-times text-red-400{{/if}} mt-0.5 text-xs'></i>
                                                                <div class='flex flex-col'>
                                                                    <span class='text-xs {{#if this.success}}text-gray-300{{else}}text-white font-semibold{{/if}}'>
                                                                        {{#if this.message}}{{this.message}}{{else}}Regla {{this.ruleType}}{{/if}}
                                                                    </span>
                                                                </div>
                                                            </div>
                                                        {{/each}}
                                                    </div>
                                                </div>
                                            {{/if}}
                                        {{/with}}
                                    </div>
                                </div>

                                {{#if (isObject value)}}
                                    <div class='bg-gray-50 p-4 rounded-lg space-y-3 border border-gray-100'>
                                        {{#each value as |childValue childKey|}}
                                            <div>
                                                <div class='flex items-center justify-between mb-1'>
                                                    <label class='block text-xs font-medium text-gray-400'>{{childKey}}</label>
                                                    <div class='flex items-center gap-2'>
                                                        {{#with (getValidation ../../process.validationResults (concat key "." childKey)) as |vals|}}
                                                            {{#if vals.length}}
                                                                <div class='tooltip group'>
                                                                    <i class='fas {{#if (hasValidationError vals)}}fa-exclamation-circle text-red-400{{else}}fa-check-circle text-green-400{{/if}} cursor-help text-xs'></i>
                                                                    <div class='tooltiptext invisible group-hover:visible opacity-0 group-hover:opacity-100 w-56 !left-auto !right-0 !ml-0 translate-x-0 p-2 text-left space-y-1.5 shadow-xl border border-gray-700 bg-gray-800 transition-all duration-200'>
                                                                        {{#each vals}}
                                                                            <div class='flex items-start gap-2 leading-tight'>
                                                                                <i class='fas {{#if this.success}}fa-check text-green-400{{else}}fa-times text-red-400{{/if}} mt-0.5 text-xs'></i>
                                                                                <span class='text-xs {{#if this.success}}text-gray-300{{else}}text-white font-semibold{{/if}}'>
                                                                                    {{#if this.message}}{{this.message}}{{else}}Regla {{this.ruleType}}{{/if}}
                                                                                </span>
                                                                            </div>
                                                                        {{/each}}
                                                                    </div>
                                                                </div>
                                                            {{/if}}
                                                        {{/with}}
                                                    </div>
                                                </div>
                                                <input type='text' name='{{key}}.{{childKey}}' value='{{childValue}}' 
                                                    class='w-full px-3 py-2 rounded border focus:ring-2 outline-none transition-all
                                                    {{#if (hasValidationError (getValidation ../../process.validationResults (concat key "." childKey)))}}border-red-300 bg-red-50 focus:ring-red-500
                                                    {{else if (hasValidationSuccess (getValidation ../../process.validationResults (concat key "." childKey)))}}border-green-300 bg-green-50 focus:ring-green-500
                                                    {{else}}border-gray-200 bg-white focus:ring-indigo-500{{/if}}'>
                                            </div>
                                        {{/each}}
                                    </div>
                                {{else if (isArray value)}}
                                    <div class='overflow-x-auto bg-gray-50 rounded-lg border border-gray-100 mt-2'>
                                        {{#if (isObject value.[0])}}
                                            <table class='w-full text-xs text-left text-gray-500'>
                                                <thead class='text-xs text-gray-700 uppercase bg-gray-100'>
                                                    <tr>
                                                        {{#each value.[0] as |v k|}}
                                                            <th class='px-3 py-2'>{{k}}</th>
                                                        {{/each}}
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    {{#each value as |row|}}
                                                        <tr class='bg-white border-b hover:bg-gray-50'>
                                                            {{#each row as |cell|}}
                                                                <td class='px-3 py-2 font-medium text-gray-900'>{{cell}}</td>
                                                            {{/each}}
                                                        </tr>
                                                    {{/each}}
                                                </tbody>
                                            </table>
                                        {{else}}
                                            <table class='w-full text-xs text-left text-gray-500'>
                                                <tbody>
                                                    {{#each value as |item|}}
                                                        <tr class='bg-white border-b last:border-0 hover:bg-gray-50'>
                                                            <td class='px-4 py-3 font-medium text-gray-700 flex items-center'>
                                                                <i class='fas fa-caret-right mr-2 text-indigo-400'></i>
                                                                {{item}}
                                                            </td>
                                                        </tr>
                                                    {{/each}}
                                                </tbody>
                                            </table>
                                        {{/if}}
                                    </div>
                                {{else}}
                                    <input type='text' name='{{key}}' value='{{value}}' 
                                        class='w-full px-4 py-3 rounded-lg border focus:ring-2 focus:outline-none transition-all
                                        {{#if (hasValidationError (getValidation ../process.validationResults key))}}border-red-300 bg-red-50 focus:ring-red-500
                                        {{else if (hasValidationSuccess (getValidation ../process.validationResults key))}}border-green-300 bg-green-50 focus:ring-green-500
                                        {{else}}border-gray-200 bg-gray-50 focus:bg-white focus:ring-indigo-500{{/if}}'>
                                {{/if}}
                            </div>
                        {{/each}}
                    </div>
                </form>
            </div>

            <div id='viewJson' class='hidden'>
                <div class='relative'>
                    <pre id='jsonPre' class='bg-gray-900 text-gray-100 px-6 py-8 rounded-xl overflow-x-auto font-mono text-sm leading-relaxed'>{{json process.extractedData}}</pre>
                    <button onclick='navigator.clipboard.writeText(document.getElementById("jsonPre").textContent)' class='absolute top-4 right-4 text-gray-400 hover:text-white transition'>
                        <i class='fas fa-copy'></i>
                    </button>
                </div>
            </div>

            <div class='mt-8 pt-8 border-t border-gray-100 space-y-4'>
                <div class='flex justify-end'>
                    <button id='saveBtn' class='bg-green-600 text-white px-6 py-2.5 rounded-lg text-sm font-bold hover:bg-green-700 transition flex items-center shadow-md'>
                        <i class='fas fa-save mr-2'></i> Guardar Modificaciones
                    </button>
                </div>
                
                <div>
                    <h4 class='text-sm font-bold text-gray-800 mb-3 uppercase tracking-wider'>Historial y Logs</h4>
                    <div class='bg-gray-900 rounded-lg p-4 max-h-60 overflow-y-auto font-mono text-xs text-gray-400 border border-gray-800 shadow-inner custom-scrollbar'>
                        <pre id='logsDisplay'>{{process.logs}}</pre>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Resizer Handle -->
    <div id='resizer' class='w-2 hover:w-3 cursor-col-resize bg-gray-100 hover:bg-indigo-300 transition-all flex items-center justify-center border-x border-gray-200 z-30'>
        <div class='h-8 w-1 bg-gray-400 rounded-full'></div>
    </div>

    <!-- Lado Derecho: Previsualización Estática -->
    <div id='previewPanel' class='w-1/2 h-full flex flex-col bg-gray-200 relative'>
        <div class='p-4 border-b border-gray-200 flex justify-between items-center bg-white z-20 shadow-sm'>
            <h3 class='font-bold text-gray-800 flex items-center'>
                <i class='fas fa-eye mr-2 text-indigo-500'></i> Documento Original
            </h3>
            <div class='flex items-center gap-4'>
                {{#unless (contains process.fileUrl ".pdf")}}
                <div class='flex items-center gap-2 bg-gray-100 px-2 py-1 rounded-lg border border-gray-200'>
                    <button id='rotateLeftBtn' class='p-1.5 text-gray-600 hover:text-indigo-600 hover:bg-white rounded-md transition' title='Rotar 90° izquierda'>
                        <i class='fas fa-undo'></i>
                    </button>
                    <button id='rotateRightBtn' class='p-1.5 text-gray-600 hover:text-indigo-600 hover:bg-white rounded-md transition' title='Rotar 90° derecha'>
                        <i class='fas fa-redo'></i>
                    </button>
                </div>
                <div class='flex items-center gap-2 bg-gray-100 px-3 py-1 rounded-lg border border-gray-200'>
                    <i class='fas fa-search-minus text-gray-400 text-xs'></i>
                    <input type='range' id='zoomRange' min='0.1' max='5' step='0.1' value='1' class='w-24 accent-indigo-600'>
                    <i class='fas fa-search-plus text-gray-400 text-xs'></i>
                    <span id='zoomValue' class='text-xs font-bold text-gray-500 min-w-[30px] ml-1'>100%</span>
                </div>
                {{/unless}}
                <a href='/admin/processes/{{process._id}}/image' target='_blank' class='bg-white p-2 rounded-lg border border-gray-200 text-indigo-600 hover:bg-indigo-50 transition shadow-sm' title='Abrir original'>
                    <i class='fas fa-external-link-alt'></i>
                </a>
            </div>
        </div>
        
        <div class='flex-1 overflow-hidden relative cursor-grab active:cursor-grabbing bg-gray-200' id='viewPort'>
            {{#if (contains process.fileUrl ".pdf")}}
                <iframe src='/admin/processes/{{process._id}}/image#toolbar=0&navpanes=0&scrollbar=1' class='w-full h-full bg-white' frameborder='0'></iframe>
            {{else}}
                <div id='panContainer' class='w-full h-full flex items-start justify-center overflow-auto custom-scrollbar'>
                    <div id='zoomWrapper' class='origin-top transition-transform duration-75 p-4' style='transform: scale(1) translate(0px, 0px);'>
                        <img src='/admin/processes/{{process._id}}/image' id='previewImage' 
                             class='max-w-none shadow-2xl rounded-sm border border-gray-300' 
                             style='height: auto; width: auto; max-width: 1000px;'
                             draggable='false' 
                             onerror='this.onerror=null; console.error("Error cargando imagen:", this.src); this.src="https://placeholder.co/1200x1800?text=Error+Vista+Previa"'>
                    </div>
                </div>
            {{/if}}
        </div>
    </div>
</div>

<style>
.custom-scrollbar::-webkit-scrollbar { width: 6px; height: 6px; }
.custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
.custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
.custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

#zoomWrapper {
    will-change: transform;
}
</style>

<script>
// --- Redimensionador (Resizer) ---
const resizer = document.getElementById('resizer');
const formPanel = document.getElementById('formPanel');
const previewPanel = document.getElementById('previewPanel');

let isResizing = false;

resizer.addEventListener('mousedown', (e) => {
    isResizing = true;
    document.body.style.cursor = 'col-resize';
    document.body.style.userSelect = 'none';
    resizer.classList.add('bg-indigo-500');
});

document.addEventListener('mousemove', (e) => {
    if (!isResizing) return;
    
    // Obtener el contenedor principal para calcular el % relativo
    const container = resizer.parentElement;
    const containerRect = container.getBoundingClientRect();
    
    // Calcular el porcentaje basado en la posición del ratón respecto al contenedor
    let newWidth = ((e.clientX - containerRect.left) / containerRect.width) * 100;
    
    // Límites de seguridad (30% - 70%)
    if (newWidth > 30 && newWidth < 70) {
        formPanel.style.width = `${newWidth}%`;
        previewPanel.style.width = `${100 - newWidth}%`;
    }
});

document.addEventListener('mouseup', () => {
    if (isResizing) {
        isResizing = false;
        document.body.style.cursor = 'default';
        document.body.style.userSelect = 'auto';
        resizer.classList.remove('bg-indigo-500');
    }
});

// --- Zoom y Pan ---
const zoomRange = document.getElementById('zoomRange');
const zoomWrapper = document.getElementById('zoomWrapper');
const viewPort = document.getElementById('viewPort');
const zoomValueDisplay = document.getElementById('zoomValue');
const rotateLeftBtn = document.getElementById('rotateLeftBtn');
const rotateRightBtn = document.getElementById('rotateRightBtn');

async function rotateImage(degrees) {
    const originalLeft = rotateLeftBtn.innerHTML;
    const originalRight = rotateRightBtn.innerHTML;
    
    rotateLeftBtn.disabled = true;
    rotateRightBtn.disabled = true;
    
    const targetBtn = degrees > 0 ? rotateRightBtn : rotateLeftBtn;
    const oldIcon = targetBtn.innerHTML;
    targetBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';

    try {
        const res = await fetch(`/api/admin/processes/{{process._id}}/rotate`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ degrees })
        });

        if (res.ok) {
            const img = document.getElementById('previewImage');
            if (img) {
                const baseUrl = img.src.split('?')[0];
                img.src = `${baseUrl}?t=${new Date().getTime()}`;
            }
            showToast('Imagen rotada correctamente');
        } else {
            showToast('Error al rotar la imagen', 'error');
            console.error('Error al rotar la imagen');
        }
    } catch (e) {
        showToast('Error de red al rotar la imagen', 'error');
        console.error('Error de red al rotar la imagen', e);
    } finally {
        rotateLeftBtn.disabled = false;
        rotateRightBtn.disabled = false;
        rotateLeftBtn.innerHTML = originalLeft;
        rotateRightBtn.innerHTML = originalRight;
    }
}

if (rotateLeftBtn) rotateLeftBtn.onclick = () => rotateImage(-90);
if (rotateRightBtn) rotateRightBtn.onclick = () => rotateImage(90);

let scale = 1;
let translateX = 0;
let translateY = 0;
let isDragging = false;
let startX, startY;

function updateTransform() {
    if (zoomWrapper) {
        zoomWrapper.style.transform = `scale(${scale}) translate(${translateX}px, ${translateY}px)`;
        if (zoomValueDisplay) zoomValueDisplay.textContent = `${Math.round(scale * 100)}%`;
    }
}

if (zoomRange && zoomWrapper) {
    zoomRange.addEventListener('input', (e) => {
        scale = parseFloat(e.target.value);
        if (scale === 1) { translateX = 0; translateY = 0; }
        updateTransform();
    });

    viewPort.addEventListener('mousedown', (e) => {
        if (scale <= 1 && e.target.id !== 'previewImage') return;
        isDragging = true;
        viewPort.classList.remove('cursor-grab');
        viewPort.classList.add('cursor-grabbing');
        startX = e.clientX - translateX * scale;
        startY = e.clientY - translateY * scale;
    });

    document.addEventListener('mousemove', (e) => {
        if (!isDragging) return;
        e.preventDefault();
        translateX = (e.clientX - startX) / scale;
        translateY = (e.clientY - startY) / scale;
        updateTransform();
    });

    document.addEventListener('mouseup', () => {
        isDragging = false;
        viewPort.classList.remove('cursor-grabbing');
        viewPort.classList.add('cursor-grab');
    });

    viewPort.addEventListener('wheel', (e) => {
        e.preventDefault();
        const delta = e.deltaY > 0 ? -0.1 : 0.1;
        scale = Math.min(Math.max(0.1, scale + delta), 5);
        if (zoomRange) zoomRange.value = scale;
        if (scale === 1) { translateX = 0; translateY = 0; }
        updateTransform();
    }, { passive: false });
}

// --- SSE y otros scripts ---
let es = new EventSource('/api/admin/processes/{{process._id}}/events');

function closeSSE() {
    if (es) {
        es.close();
        es = null;
    }
}

es.onmessage = e => {
    const data = JSON.parse(e.data);
    const logs = document.getElementById('logsDisplay');
    if (logs && data.logs) {
        logs.textContent = data.logs;
        logs.parentElement.scrollTop = logs.parentElement.scrollHeight;
    }
    const badge = document.getElementById('statusBadge');
    if (badge && badge.textContent.trim().toLowerCase() !== data.status.toLowerCase()) {
        const oldStatus = badge.textContent.trim().toLowerCase();
        badge.textContent = data.status;
        
        // Actualizar estado del botón de reprocesar
        const btn = document.getElementById('reprocessBtn');
        const finalStates = ['completed', 'validated', 'failed', 'error'];
        if (finalStates.includes(data.status.toLowerCase())) {
            if (btn) {
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-sync-alt mr-2"></i> Reprocesar';
                btn.classList.remove('opacity-50', 'cursor-not-allowed');
            }
        }

        if (data.status.toLowerCase() === 'completed') {
            badge.className = 'inline-flex items-center px-3 py-1 rounded-full text-sm font-bold bg-green-100 text-green-800';
            // Solo recargamos si veníamos de un estado de procesamiento para evitar bucles
            if (oldStatus === 'processing' || oldStatus === 'pending') {
                closeSSE();
                setTimeout(() => location.reload(), 500);
            }
        } else if (data.status.toLowerCase() === 'validated') {
            badge.className = 'inline-flex items-center px-3 py-1 rounded-full text-sm font-bold bg-green-600 text-white shadow-sm';
            badge.innerHTML = '<i class="fas fa-certificate mr-1.5"></i> validated';
        } else if (data.status.toLowerCase() === 'processing') {
            badge.className = 'inline-flex items-center px-3 py-1 rounded-full text-sm font-bold bg-blue-100 text-blue-800';
        } else {
            badge.className = 'inline-flex items-center px-3 py-1 rounded-full text-sm font-bold bg-red-100 text-red-800';
        }
    }
};

document.getElementById('tabFormBtn').onclick = () => {
    document.getElementById('viewForm').classList.remove('hidden');
    document.getElementById('viewJson').classList.add('hidden');
    document.getElementById('tabFormBtn').className = 'px-4 py-2 text-sm font-medium bg-white rounded-md shadow-sm transition-all';
    document.getElementById('tabJsonBtn').className = 'px-4 py-2 text-sm font-medium text-gray-600 transition-all';
};

document.getElementById('tabJsonBtn').onclick = () => {
    document.getElementById('viewForm').classList.add('hidden');
    document.getElementById('viewJson').classList.remove('hidden');
    document.getElementById('tabJsonBtn').className = 'px-4 py-2 text-sm font-medium bg-white rounded-md shadow-sm transition-all';
    document.getElementById('tabFormBtn').className = 'px-4 py-2 text-sm font-medium text-gray-600 transition-all';
};

document.getElementById('saveBtn').onclick = async () => {
    const btn = document.getElementById('saveBtn');
    const originalHtml = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Guardando...';

    const formData = new FormData(document.getElementById('extractionForm'));
    const extractedData = {};
    for (const [key, value] of formData.entries()) {
        const keys = key.split('.');
        let current = extractedData;
        while (keys.length > 1) {
            const k = keys.shift();
            current[k] = current[k] || {};
            current = current[k];
        }
        current[keys[0]] = value;
    }

    try {
        const res = await fetch('/api/admin/processes/{{process._id}}/update-data', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(extractedData)
        });

        if (res.ok) {
            btn.innerHTML = '<i class="fas fa-check mr-2"></i> Guardado';
            btn.classList.replace('bg-green-600', 'bg-blue-600');
            showToast('Datos guardados correctamente');
            setTimeout(() => {
                btn.disabled = false;
                btn.innerHTML = originalHtml;
                btn.classList.replace('bg-blue-600', 'bg-green-600');
            }, 2000);
        } else {
            showToast('Error al guardar datos', 'error');
            btn.disabled = false;
            btn.innerHTML = originalHtml;
        }
    } catch (err) {
        showToast('Error de red al conectar con el servidor', 'error');
        btn.disabled = false;
        btn.innerHTML = originalHtml;
    }
};

document.getElementById('reprocessBtn').onclick = async () => {
    const btn = document.getElementById('reprocessBtn');
    btn.disabled = true;
    btn.classList.add('opacity-50', 'cursor-not-allowed');
    btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Procesando...';
    
    try {
        const res = await fetch('/api/admin/processes/{{process._id}}/reprocess', { method: 'POST' });
        if (res.ok) {
            showToast('Reprocesamiento iniciado');
        } else {
            throw new Error();
        }
    } catch (err) {
        btn.disabled = false;
        btn.classList.remove('opacity-50', 'cursor-not-allowed');
        btn.innerHTML = '<i class="fas fa-sync-alt mr-2"></i> Reprocesar';
        showToast('Error al solicitar el reprocesamiento', 'error');
    }
};

// --- Cambio de Estado al modificar formulario ---
const extractionForm = document.getElementById('extractionForm');
extractionForm.addEventListener('input', async (e) => {
    const badge = document.getElementById('statusBadge');
    // Si ya está validado, significa que el cambio invalida ese estado
    if (badge && badge.textContent.trim().toLowerCase() === 'validated') {
        badge.textContent = 'completed';
        badge.className = 'inline-flex items-center px-3 py-1 rounded-full text-sm font-bold bg-green-100 text-green-800';
        
        // Notificamos al servidor del cambio de estado por modificación
        try {
            await fetch('/api/admin/processes/{{process._id}}/revert-to-completed', { method: 'POST' });
        } catch(err) { console.error("Error revert status", err); }
    }
});

document.getElementById('validateBtn').onclick = async () => {
    const btn = document.getElementById('validateBtn');
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Validando...';

    // 1. Recolectar datos del formulario (soporta anidamiento ligero)
    const formData = new FormData(document.getElementById('extractionForm'));
    const extractedData = {};
    
    for (const [key, value] of formData.entries()) {
        const keys = key.split('.');
        let current = extractedData;
        while (keys.length > 1) {
            const k = keys.shift();
            current[k] = current[k] || {};
            current = current[k];
        }
        current[keys[0]] = value;
    }

    try {
        const res = await fetch('/api/admin/processes/{{process._id}}/validate', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(extractedData)
        });

        if (res.ok) {
            // Cerramos SSE antes de recargar para evitar errores de conexión interrumpida
            closeSSE();
            showToast('Documento validado correctamente');
            setTimeout(() => window.location.reload(), 1000);
        } else {
            showToast('Error al validar datos', 'error');
            btn.disabled = false;
            btn.innerHTML = '<i class="fas fa-check-double mr-2"></i> Validar Datos';
        }
    } catch (err) {
        showToast('Error de red al validar datos', 'error');
        btn.disabled = false;
        btn.innerHTML = '<i class="fas fa-check-double mr-2"></i> Validar Datos';
    }
};

// --- Control de Modos de Visualización (Lista vs Secciones) ---
let currentViewMode = 'list';

function setViewMode(mode) {
    currentViewMode = mode;
    const btn = document.getElementById('toggleViewModeBtn');
    const label = document.getElementById('viewModeLabel');
    const icon = document.getElementById('toggleViewIcon');
    const tabsNav = document.getElementById('formTabsNav');
    const groups = document.querySelectorAll('.form-field-group');

    if (mode === 'sections') {
        label.textContent = 'Vista por Secciones';
        btn.querySelector('span').textContent = 'Mostrar Lista Contínua';
        icon.className = 'fas fa-list text-xs';
        tabsNav.classList.remove('hidden');
        
        // Activar la primera pestaña por defecto
        const firstTab = document.querySelector('.form-tab-btn');
        if (firstTab) switchTab(firstTab.dataset.tab);
    } else {
        label.textContent = 'Lista Contínua';
        btn.querySelector('span').textContent = 'Agrupar por Secciones';
        icon.className = 'fas fa-th-large text-xs';
        tabsNav.classList.add('hidden');
        
        // Mostrar todos los grupos
        groups.forEach(g => g.classList.remove('hidden'));
    }
}

function switchTab(tabKey) {
    const groups = document.querySelectorAll('.form-field-group');
    const tabs = document.querySelectorAll('.form-tab-btn');
    
    tabs.forEach(t => {
        if (t.dataset.tab === tabKey) {
            t.classList.add('border-indigo-600', 'text-indigo-600', 'bg-indigo-50/20');
            t.classList.remove('border-transparent', 'text-gray-400');
        } else {
            t.classList.remove('border-indigo-600', 'text-indigo-600', 'bg-indigo-50/20');
            t.classList.add('border-transparent', 'text-gray-400');
        }
    });

    groups.forEach(g => {
        if (g.dataset.group === tabKey) {
            g.classList.remove('hidden');
        } else {
            g.classList.add('hidden');
        }
    });
}

document.getElementById('toggleViewModeBtn').onclick = () => {
    setViewMode(currentViewMode === 'list' ? 'sections' : 'list');
};

document.querySelectorAll('.form-tab-btn').forEach(btn => {
    btn.onclick = () => switchTab(btn.dataset.tab);
});
</script>
